# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**OperacionesRanger - Sistema de Gestión de Turnos** is a shift management system for security guards (guardianes de seguridad) for COOPASPIRE in the Dominican Republic. The system tracks daily shifts, calculates work hours (normal/overtime, day/night), identifies holidays, and generates biweekly reports for payroll integration.

**Current Status**: Project in early development phase - database schema designed, architecture defined, awaiting backend and frontend implementation.

**Planned Architecture**:
- **Backend**: Node.js + TypeScript + Express.js
- **Frontend**: Angular
- **Database**: MySQL 8.0 (schema: `sistema_turnos_guardianes.sql`)

## Database Setup

### Initial Setup Commands

```bash
# Connect to MySQL (Windows)
"C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe" -u root -p

# Create database and load schema
mysql -u root -p < sistema_turnos_guardianes.sql

# Verify installation
mysql -u root -p -e "USE turnos_guardianes; SHOW TABLES;"
```

### Database Structure

The system uses a hierarchical structure:

```
CLIENTE (Client Company)
  └── UBICACIÓN (Physical Location)
        └── PUESTO (Guard Post/Station)
              ├── TURNO (Shift Record)
              └── INCENTIVO_PUESTO (Post Incentive)
```

**Key Tables**:
- `configuracion_turnos`: Day/night shift time ranges (configurable, default: 06:00-18:00 day, 18:00-06:00 night)
- `clientes`: Companies contracting security services
- `ubicaciones`: Physical locations where service is provided
- `puestos`: Specific posts/stations requiring guards
- `feriados`: National and decree holidays (types: NACIONAL, DECRETO)
- `turnos`: **Main table** - daily shift records per guard with auto-calculated fields
- `incentivos_puesto`: Incentive amounts per post per biweekly period

**Important**: The `turnos` table references an external `rh_empleado` table from the HR/Payroll system (`db_aae4a2_ranger` database).

### Stored Procedures

- `sp_registrar_turno`: Register a shift with auto-validation and calculations
- `sp_generar_reporte_nomina`: Generate CSV report for payroll system
- `sp_verificar_feriado`: Check if a date is a holiday
- `sp_determinar_tipo_turno`: Determine shift type (DAY/NIGHT) based on entry time

### Triggers

- `trg_turnos_before_insert`: Validates shift hours (max 12 normal + 4 extra = 16 total)

## Business Rules

### Shift Hours
- **Normal hours**: Up to 10 hours per shift
- **Overtime hours**: Up to 2 hours per shift
- **Absolute maximum**: 16 hours per shift (validated by trigger)

### Shift Classification
Automatically determined by entry time:
- **DIURNO (Day)**: Entry time 06:00-18:00 (configurable in `configuracion_turnos`)
- **NOCTURNO (Night)**: Entry time 18:00-06:00 (configurable in `configuracion_turnos`)

### Holidays
- **NACIONAL**: Annual recurring holidays (New Year, Independence Day, etc.)
- **DECRETO**: Special holidays by presidential decree
- **Note**: Sundays are normal days UNLESS explicitly marked in the `feriados` table

### Incentives
- Assigned per **post** and **biweekly period** (quincena)
- Calculation: `monto / 360 hours` (15 days × 24 hours) = hourly rate
- Each guard receives proportional incentive for hours worked at that post
- The `valor_hora` field is auto-calculated as a GENERATED column

## Integration with HR/Payroll System

### Employee Table Reference

The system integrates with an existing HR/Payroll database:

**Database**: `db_aae4a2_ranger`
**Table**: `rh_empleado`
**Connection**: Read-only access via foreign key `turnos.empleado_id`

**Required fields from HR system**:
- `id_empleado` (INT) - Primary key, referenced in `turnos` table
- `cedula_empleado` (VARCHAR) - National ID
- `nombres` + `apellidos` (VARCHAR) - Employee name
- `status` (TINYINT) - Active status (1 = active, 0 = inactive)
- `id_puesto` (INT) - Job position ID (97 = "VIGILANTE DE SEGURIDAD")

**Security Guards Filter**: `WHERE id_puesto = 97 AND status = 1`

### Payroll CSV Export Format

Generated by `sp_generar_reporte_nomina(fecha_inicio, fecha_fin)`:

```csv
fecha,empleado_id,puesto_codigo,horas_normales,horas_extras,tipo_turno,es_feriado,tipo_feriado,incentivo
2026-01-02,1001,P001,10.00,2.00,DIURNO,NO,N/A,120.00
2026-01-21,1001,P002,8.00,2.00,DIURNO,SI,NACIONAL,0.00
```

**Integration Workflow**:
1. Supervisor selects date range (biweekly period: quincena)
2. System executes `sp_generar_reporte_nomina(start_date, end_date)`
3. Export to CSV: `nomina_YYYYMMDD_YYYYMMDD.csv`
4. Payroll system processes CSV and assigns `nomina_id`
5. Update processed shifts: `procesado_nomina = TRUE`

## Development Methodology

This project follows a **coordinated agent-based development methodology** documented in `Metodologia.md`.

### Key Concepts

**Two Agent Types**:
1. **Coordinator Agent** (Main Claude): Orchestrates tasks, delegates to subagents, tracks progress
2. **Subagent**: Executes specific tasks autonomously (planning → execution → documentation)

### Directory Structure

```
OperacionesRanger/
├── CLAUDE.md                    # This file
├── Metodologia.md               # Development methodology (READ THIS)
├── especificaciones_sistema_turnos.md  # Detailed system specs
├── diagrama_er_turnos.md       # ER diagram documentation
├── sistema_turnos_guardianes.sql  # Database schema
├── docs/
│   ├── plans/                   # Task execution plans (plan_T00X_YYYYMMDD.md)
│   ├── tasks/                   # Task tracking files (tareas_faseN_YYYYMMDD.md)
│   ├── completed/               # Completed task results (T00X_nombre_tarea.md)
│   ├── decisions/               # Architecture Decision Records (ADRs)
│   ├── reports/                 # Phase completion reports
│   └── logs/                    # Coordinator logs (optional)
├── backend/                     # Backend code (Node.js + TypeScript) - TBD
└── frontend/                    # Frontend code (Angular) - TBD
```

### Task Management

**Task States**:
- `[ ]` Pendiente (Pending)
- `[→]` En progreso (In Progress)
- `[✓]` Completada (Completed)
- `[x]` Bloqueada (Blocked)
- `[~]` Cancelada (Cancelled)

**Task Files**: Located in `docs/tasks/tareas_faseN_YYYYMMDD.md`

**When Starting Work**:
1. Read `Metodologia.md` to understand workflow
2. Check latest task file in `docs/tasks/`
3. Identify next pending task with no blocked dependencies
4. If coordinator role: Create plan → Launch subagent → Validate → Update task status
5. If subagent role: Create plan → Execute → Document → Report completion

## Architecture Decisions

### ADR-001: Backend Stack Selection

**Decision**: Node.js + TypeScript + Express.js
**Date**: 2026-01-17
**Status**: Accepted
**File**: `docs/decisions/001_eleccion_stack_backend.md`

**Rationale**:
- Team expertise in JavaScript ecosystem
- Fast development cycle
- Excellent MySQL integration (mysql2, Sequelize)
- Strong typing with TypeScript
- Lightweight and performant for CRUD operations

### Database Schema Decisions

**Dual Connection Strategy**:
- **Primary DB**: `turnos_guardianes` (new system, read/write)
- **Secondary DB**: `db_aae4a2_ranger` (HR system, read-only)

**Why Stored Procedures**:
- Complex business logic (shift type auto-detection, holiday verification)
- Automatic calculations (incentive hourly rate, processed status)
- Data integrity validation (hours limits, duplicate prevention)
- Performance optimization (batch report generation)

## Important Database Constraints

### Hours Validation (Enforced by Trigger)
```sql
-- Maximum limits per shift
Normal hours: <= 12
Extra hours: <= 4
Total hours: <= 16
```

### Auto-Calculated Fields
- `tipo_turno`: Determined by `sp_determinar_tipo_turno(hora_entrada)`
- `es_feriado`: Checked via `sp_verificar_feriado(fecha)`
- `incentivos_puesto.valor_hora`: GENERATED ALWAYS AS `monto / 360`

### Duplicate Prevention
- **Constraint**: `uk_empleado_puesto_fecha (empleado_id, puesto_id, fecha)`
- **Effect**: Cannot register same employee at same post on same date twice

## MySQL Configuration

**Connection Details** (for development):
- Host: `localhost`
- Port: `3306` (default)
- Database: `turnos_guardianes`
- User: `root` (development only)
- Password: Stored in environment variables (`.env`)

**IMPORTANT**: Production credentials MUST be stored in environment variables, never in code.

## Next Development Phases

### Phase 1: Foundation (Current)
- [x] Database schema design
- [x] Architecture decisions
- [x] HR table investigation
- [ ] Load initial data (holidays, shift configuration)
- [ ] Validate stored procedures
- [ ] Backend project structure setup
- [ ] Database connection configuration

### Phase 2: Backend Core
- [ ] API endpoints for master data (clients, locations, posts)
- [ ] Shift registration endpoint (calls `sp_registrar_turno`)
- [ ] Payroll report generation endpoint
- [ ] Authentication system
- [ ] Integration with HR employee table

### Phase 3: Frontend
- [ ] Client/location/post management modules
- [ ] Shift calendar/agenda component
- [ ] Shift registration form
- [ ] Incentives management module
- [ ] Report generation and CSV export

### Phase 4: Integration & Testing
- [ ] Connect to HR employee table
- [ ] CSV export validation with payroll system
- [ ] End-to-end testing
- [ ] User acceptance testing

## Common Queries

### Get Active Security Guards
```sql
SELECT
    e.id_empleado,
    e.cedula_empleado,
    CONCAT(e.nombres, ' ', e.apellidos) AS nombre_completo,
    e.status
FROM db_aae4a2_ranger.rh_empleado e
WHERE e.id_puesto = 97  -- VIGILANTE DE SEGURIDAD
  AND e.status = 1;     -- Active only
```

### Register a Shift (Using Stored Procedure)
```sql
CALL sp_registrar_turno(
    1001,              -- empleado_id
    42,                -- puesto_id
    '2026-01-15',      -- fecha
    '06:00:00',        -- hora_entrada
    '18:00:00',        -- hora_salida
    10.00,             -- horas_normales
    2.00,              -- horas_extras
    1                  -- created_by (user_id)
);
```

### Generate Payroll Report
```sql
CALL sp_generar_reporte_nomina('2026-01-01', '2026-01-15');
```

### Check Holidays for a Date
```sql
CALL sp_verificar_feriado('2026-01-01');
```

## Key Files to Reference

- **`especificaciones_sistema_turnos.md`**: Complete business requirements and system specs
- **`diagrama_er_turnos.md`**: Entity-Relationship diagram with detailed field descriptions
- **`Metodologia.md`**: Development workflow (coordinator/subagent methodology)
- **`sistema_turnos_guardianes.sql`**: Complete database schema with comments

## Development Notes

- All dates use ISO 8601 format: `YYYY-MM-DD`
- All times use 24-hour format: `HH:MM:SS`
- Database uses `utf8mb4_unicode_ci` collation
- All tables include `created_at` and `updated_at` audit timestamps
- Biweekly periods (quincenas): Days 1-15 and 16-end of month
- Security guards work schedule: Can include weekends and holidays
- Sundays are treated as normal workdays unless marked as holidays

## Important Warnings

⚠️ **Never commit**:
- `.env` files with real credentials
- Database dumps with real employee data
- API keys or authentication tokens

⚠️ **Database Safety**:
- Always use prepared statements to prevent SQL injection
- Use transactions for multi-step operations
- Never delete historical shift records (archive instead)
- Closed payroll periods (`procesado_nomina = TRUE`) should be immutable

⚠️ **Integration Considerations**:
- HR employee table (`rh_empleado`) is read-only for this system
- Do not modify employee data from the shift system
- Always validate employee exists and is active before creating shifts
- Ensure `empleado_id` references match between systems

---

**Last updated**: 2026-01-17
**Project Phase**: Phase 1 - Foundation
**Backend Status**: Not started
**Frontend Status**: Not started
**Database Status**: Schema designed, awaiting deployment
